<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OFD Viewer</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Microsoft YaHei", sans-serif; }
    .toolbar { position: sticky; top:0; z-index: 10; display:flex; gap:8px; align-items:center; padding:8px; background:#f7f7f7; border-bottom:1px solid #ddd; }
    .toolbar button, .toolbar input, .toolbar select { padding:6px 10px; font-size: 14px; }
    .toolbar .spacer { flex:1; }
    .viewer-container { position: relative; height: calc(100% - 50px); overflow: auto; background:#e9eaee; }
    .page-wrapper { display:flex; justify-content:center; padding: 16px; }
    .page { transform-origin: top center; background: white; box-shadow: 0 2px 10px rgba(0,0,0,.15); }
    .hidden { display: none; }
    .error { color: #c00; margin: 16px; }
    .status { margin-left: 8px; color: #666; }
    #svgHolder svg text { user-select: text; }
    body.no-select #svgHolder svg text { user-select: none; pointer-events: none; }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="zoomOut" title="缩小">-</button>
    <button id="zoomIn" title="放大">+</button>
    <button id="resetZoom" title="还原">100%</button>
    <span class="status" id="zoomLabel">100%</span>
    <span class="status" id="engineStatus"></span>

    <button id="prevPage" title="前一页">←</button>
    <button id="nextPage" title="下一页">→</button>
    <span>第 <input id="gotoInput" type="number" min="1" style="width:60px"> / <span id="totalPages">?</span> 页</span>

    <div class="spacer"></div>

    <label><input type="checkbox" id="toggleText"> 文本选择模式</label>

    <button id="downloadPng" title="下载当前页 PNG">下载PNG</button>
    <button id="downloadPdf" title="下载当前页 PDF">下载PDF</button>
    <button id="downloadOfd" title="下载原始 OFD">下载OFD</button>
  </div>

  <div class="viewer-container" id="viewer">
    <div class="page-wrapper">
      <div class="page" id="page" style="transform: scale(1);">
        <div id="loading">加载中...</div>
        <div id="error" class="error hidden"></div>
        <div id="svgHolder"></div>
        <img id="imgHolder" class="hidden" />
        <iframe id="pdfHolder" class="hidden" style="border:0;width:100%;height:90vh;"></iframe>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const params = new URLSearchParams(location.search);
    const file = params.get('file') || 'sample.ofd';

    const state = {
      page: 1,
      total: 1,
      zoom: parseFloat(localStorage.getItem('zoom') || '1'),
      textSelectable: localStorage.getItem('textSelectable') === '1',
      engine: '',
      capabilities: null,
    };

    const zoomLabel = document.getElementById('zoomLabel');
    const totalPages = document.getElementById('totalPages');
    const gotoInput = document.getElementById('gotoInput');
    const svgHolder = document.getElementById('svgHolder');
    const imgHolder = document.getElementById('imgHolder');
    const pdfHolder = document.getElementById('pdfHolder');
    const engineStatus = document.getElementById('engineStatus');

    function setZoom(z) {
      state.zoom = Math.max(0.2, Math.min(4, z));
      zoomLabel.textContent = Math.round(state.zoom * 100) + '%';
      document.getElementById('page').style.transform = 'scale(' + state.zoom + ')';
      localStorage.setItem('zoom', state.zoom.toString());
    }

    function setTextSelectable(on) {
      state.textSelectable = !!on;
      if (state.textSelectable) document.body.classList.remove('no-select');
      else document.body.classList.add('no-select');
      localStorage.setItem('textSelectable', on ? '1' : '0');
    }

    function updateEngineStatus() {
      if (!engineStatus) return;
      const caps = state.capabilities || {};
      const mark = (value) => value === undefined ? '?' : (value ? '✓' : '✕');
      if (!state.engine) {
        engineStatus.textContent = '';
        engineStatus.title = '';
        return;
      }
      let label;
      if (state.engine === 'ofdrw-cli') label = '渲染: OFDRW';
      else if (state.engine === 'basic') label = '渲染: 基础';
      else label = '渲染: ' + state.engine;
      engineStatus.textContent = label;
      engineStatus.title = `功能: 文本=${mark(caps.text)}, 图形=${mark(caps.vector)}, 图片=${mark(caps.images)}, 注释=${mark(caps.annotations)}, 签章=${mark(caps.signatures)}`;
    }

    async function loadMeta() {
      const res = await fetch(`/api/ofd/metadata?file=${encodeURIComponent(file)}`);
      if (!res.ok) throw new Error(await res.text());
      const meta = await res.json();
      state.total = meta.pages;
      state.engine = meta.engine || '';
      state.capabilities = meta.capabilities || null;
      updateEngineStatus();
      totalPages.textContent = String(meta.pages);
      gotoInput.value = String(state.page);
      const toggleText = document.getElementById('toggleText');
      const textCapable = meta.textExtractable && (!state.capabilities || state.capabilities.text !== false);
      if (textCapable) {
        toggleText.disabled = false;
        toggleText.title = '文本选择模式';
      } else {
        state.textSelectable = false;
        toggleText.disabled = true;
        toggleText.checked = false;
        toggleText.title = '此文件不支持文本选择';
        setTextSelectable(false);
      }
    }

    async function loadPage() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('error').classList.add('hidden');
      svgHolder.innerHTML = ''; imgHolder.classList.add('hidden'); pdfHolder.classList.add('hidden');
      try {
        const res = await fetch(`/api/ofd/page?file=${encodeURIComponent(file)}&page=${state.page}&format=svg`);
        if (!res.ok) throw new Error(await res.text());
        const svgText = await res.text();
        const div = document.createElement('div');
        div.innerHTML = svgText;
        const svg = div.firstElementChild;
        svgHolder.innerHTML = '';
        svgHolder.appendChild(svg);
      } catch (e) {
        const err = document.getElementById('error');
        err.textContent = '渲染失败: ' + e.message;
        err.classList.remove('hidden');
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function downloadCurrent(fmt) {
      const url = `/api/ofd/page?file=${encodeURIComponent(file)}&page=${state.page}&format=${fmt}`;
      const a = document.createElement('a');
      a.href = url; a.download = `page-${state.page}.${fmt}`; a.click();
    }

    document.getElementById('zoomIn').onclick = () => setZoom(state.zoom + 0.1);
    document.getElementById('zoomOut').onclick = () => setZoom(state.zoom - 0.1);
    document.getElementById('resetZoom').onclick = () => setZoom(1);
    document.getElementById('prevPage').onclick = () => { if (state.page > 1) { state.page--; gotoInput.value = String(state.page); loadPage(); } };
    document.getElementById('nextPage').onclick = () => { if (state.page < state.total) { state.page++; gotoInput.value = String(state.page); loadPage(); } };
    document.getElementById('downloadPng').onclick = () => downloadCurrent('png');
    document.getElementById('downloadPdf').onclick = () => downloadCurrent('pdf');
    document.getElementById('downloadOfd').onclick = () => { const a=document.createElement('a'); a.href=`/api/ofd/raw?file=${encodeURIComponent(file)}`; a.download = (file.split('/').pop()||'file.ofd'); a.click(); };

    gotoInput.onkeydown = (e) => { if (e.key === 'Enter') { const v = parseInt(gotoInput.value||'1'); if (v>=1 && v<=state.total) { state.page=v; loadPage(); } } };

    const toggleText = document.getElementById('toggleText');
    toggleText.checked = state.textSelectable;
    setTextSelectable(state.textSelectable);
    toggleText.onchange = () => {
      if (!toggleText.disabled) setTextSelectable(toggleText.checked);
    };

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      if (e.key === '+') setZoom(state.zoom + 0.1);
      else if (e.key === '-') setZoom(state.zoom - 0.1);
      else if (e.key === '0') setZoom(1);
      else if (e.key === 'ArrowLeft') { if (state.page>1) { state.page--; gotoInput.value=String(state.page); loadPage(); } }
      else if (e.key === 'ArrowRight') { if (state.page<state.total) { state.page++; gotoInput.value=String(state.page); loadPage(); } }
      else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        alert('搜索功能未实现，未来版本提供');
      }
    });

    // Touch basic support
    let startX = 0; let lastScale = state.zoom; let startDist = 0;
    document.getElementById('viewer').addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) startX = e.touches[0].clientX;
      if (e.touches.length === 2) {
        startDist = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY,
        );
        lastScale = state.zoom;
      }
    }, { passive: true });

    document.getElementById('viewer').addEventListener('touchmove', (e) => {
      if (e.touches.length === 1 && startX) {
        const dx = e.touches[0].clientX - startX;
        if (Math.abs(dx) > 60) {
          if (dx > 0 && state.page>1) { state.page--; gotoInput.value=String(state.page); loadPage(); }
          if (dx < 0 && state.page<state.total) { state.page++; gotoInput.value=String(state.page); loadPage(); }
          startX = 0;
        }
      }
      if (e.touches.length === 2 && startDist) {
        const dist = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY,
        );
        const factor = dist / startDist;
        setZoom(lastScale * factor);
      }
    }, { passive: true });

    setZoom(state.zoom);
    loadMeta().then(loadPage).catch(err => {
      document.getElementById('loading').classList.add('hidden');
      const e = document.getElementById('error'); e.textContent = '加载失败: ' + err.message; e.classList.remove('hidden');
    });
  })();
  </script>
</body>
</html>
